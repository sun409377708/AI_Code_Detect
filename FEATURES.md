# 🚀 PR-Agent 可视化管理平台 - 功能说明

## 📋 目录

- [核心功能总览](#核心功能总览)
- [Webhook 自动审查](#webhook-自动审查)
- [批量管理功能](#批量管理功能)
- [审查报表](#审查报表)
- [配置管理](#配置管理)
- [用户界面](#用户界面)
- [技术特性](#技术特性)

---

## 🎯 核心功能总览

| 功能模块 | 功能点 | 说明 |
|---------|-------|------|
| **AI 代码审查** | MR 审查 | 基于通义千问大模型的智能 MR 审查 |
| | Commit 审查 | 每次 Push 自动审查 Commit |
| | 中文报告 | 生成中文审查报告和建议 |
| | 自动发布 | 评论自动发布到 GitLab |
| **GitLab 集成** | API 集成 | 完整的 GitLab API 集成 |
| | 内网支持 | 支持公司内部 GitLab 服务器 |
| | Webhook | 自动接收和处理 Webhook 事件 |
| | 项目管理 | 浏览和管理 GitLab 项目 |
| **可视化管理** | Web 界面 | 现代化的 Web 管理界面 |
| | 项目浏览 | 按组浏览和搜索项目 |
| | 批量操作 | 批量配置/删除 Webhook |
| | 数据报表 | 审查数据统计和展示 |

---

## 🔔 Webhook 自动审查

### **MR Webhook 触发场景**

| 场景 | Action | 是否审查 | 是否记录 | 说明 |
|------|--------|:-------:|:-------:|------|
| **创建 MR** | `open` | ✅ | ✅ | 首次创建 MR，完整审查 |
| **重新打开 MR** | `reopen` | ✅ | ✅ | 关闭后重新打开，重新审查 |
| **推送新 commit** | `update` | ✅ | ✅ | 有新代码变更，记录并审查 |
| **修改标题/描述** | `update` | ✅ | ❌ | 无代码变更，仅审查不记录 |
| **添加标签** | `update` | ✅ | ❌ | 无代码变更，仅审查不记录 |
| **修改 Assignee** | `update` | ✅ | ❌ | 无代码变更，仅审查不记录 |
| **关闭 MR** | `close` | ❌ | ❌ | 跳过，不处理 |
| **合并 MR** | `merge` | ❌ | ❌ | 跳过，不处理 |

### **Push Webhook 触发场景**

| 场景 | 是否审查 | 是否记录 | 说明 |
|------|:-------:|:-------:|------|
| **推送新 commit** | ✅ | ✅ | 审查每个新 commit |
| **推送已审查的 commit** | ❌ | ❌ | 数据库去重，自动跳过 |
| **Merge commit** | ❌ | ❌ | 自动识别并跳过 |
| **新分支首次推送（配置开启）** | ✅ | ✅ | 审查所有历史 commits |
| **新分支首次推送（配置关闭）** | ❌ | ❌ | 跳过历史，只审查后续 |

### **去重机制**

| 类型 | 去重方式 | 检查内容 | 效果 |
|------|---------|---------|------|
| **MR 去重** | 数据库 + GitLab API | 检查是否已有审查记录和评论 | 避免重复审查同一 MR |
| **Commit 去重** | 数据库 | 检查 commit SHA 是否已审查 | 避免重复审查同一 commit |
| **Merge commit** | 父节点检查 | 检查是否有多个父节点 | 自动跳过合并提交 |
| **Update 去重** | oldrev 检查 | 检查是否有新 commit | 无新代码不记录 |

---

## 🔗 批量管理功能

### **批量配置 Webhook**

| 功能项 | 说明 | 操作 |
|-------|------|------|
| **选择项目** | 按组浏览和选择项目 | 勾选需要配置的项目 |
| **自动检测** | 检测已配置的项目 | 显示配置状态（已配置/未配置） |
| **批量配置** | 一键为多个项目配置 | 点击"开始批量配置" |
| **更新配置** | 更新现有 Webhook | 自动更新已存在的 Webhook |
| **进度显示** | 实时显示配置进度 | 进度条 + 成功/失败统计 |
| **结果反馈** | 显示详细配置结果 | 成功/更新/跳过/失败分类 |

**配置内容：**

| 配置项 | 值 | 说明 |
|-------|---|------|
| **Webhook URL** | `http://your-server:8080/webhook/gitlab` | 接收 Webhook 的地址 |
| **触发事件** | Merge Request events | MR 创建/更新时触发 |
| | Push events | 代码推送时触发 |
| **分支过滤** | `*` | 所有分支 |
| **SSL 验证** | 关闭 | 内网环境可关闭 |

### **批量删除 Webhook**

| 功能项 | 说明 | 操作 |
|-------|------|------|
| **查看已配置** | 显示所有已配置项目 | 点击"查看已配置项目" |
| **多选删除** | 支持勾选多个项目 | 勾选需要删除的项目 |
| **全选功能** | 一键全选/取消全选 | 点击表头复选框 |
| **二次确认** | 删除前确认 | 防止误操作 |
| **批量执行** | 一键删除多个 Webhook | 点击"批量删除" |
| **结果统计** | 显示删除结果 | 成功/跳过/失败统计 |

### **查看已配置项目**

| 显示内容 | 说明 |
|---------|------|
| **项目信息** | 项目名称、路径、所属组 |
| **Webhook 状态** | ✅ 正常 / ⚠️ URL 不匹配 |
| **全局配置** | MR 审查状态、Commit 审查状态 |
| **操作按钮** | 打开项目、查看 Webhook、删除 |
| **批量操作** | 批量删除选中项目的 Webhook |

**Webhook 状态说明：**

| 状态 | 图标 | 说明 |
|------|-----|------|
| **正常** | ✅ | Webhook URL 匹配当前服务器 |
| **URL 不匹配** | ⚠️ | Webhook 指向其他服务器地址 |
| **未配置** | ❌ | 项目没有配置 Webhook |

---

## 📊 审查报表

### **筛选功能**

| 筛选项 | 选项 | 说明 |
|-------|------|------|
| **时间范围** | 开始日期 - 结束日期 | 选择审查记录的时间范围 |
| | 今天 | 快捷选择今天的记录 |
| | 本周 | 快捷选择本周的记录 |
| | 本月 | 快捷选择本月的记录 |
| **审查类型** | 全部 | 显示所有审查记录 |
| | MR 审查 | 只显示 MR 审查记录 |
| | Commit 审查 | 只显示 Commit 审查记录 |

### **数据展示**

| 列名 | 内容 | 说明 |
|------|------|------|
| **审查时间** | `2025-11-11 15:30:45` | 中国时区（UTC+8） |
| **类型** | MR / Commit | 审查类型标识 |
| **项目** | `dytsh/iosdytsh/new_doctor` | 项目完整路径 |
| **标题** | MR 标题 / Commit 消息 | 审查对象的标题 |
| **作者** | 提交者姓名 | 代码作者 |
| **分支** | 目标分支 | MR 的目标分支 |
| **操作** | 查看详情 | 跳转到 GitLab 页面 |

### **统计信息**

| 统计项 | 说明 |
|-------|------|
| **总审查次数** | 所有审查记录总数 |
| **MR 审查次数** | MR 审查记录数量 |
| **Commit 审查次数** | Commit 审查记录数量 |
| **时间范围** | 当前筛选的时间范围 |

### **时区处理**

| 项目 | 时区 | 说明 |
|------|-----|------|
| **数据库存储** | UTC+8 | 存储中国时区时间 |
| **报表显示** | UTC+8 | 显示中国时区时间 |
| **API 返回** | UTC+8 | ISO 格式含时区信息 |
| **历史记录** | UTC+8 | 所有时间统一使用中国时区 |

---

## ⚙️ 配置管理

### **全局配置项**

| 配置分类 | 配置项 | 默认值 | 说明 |
|---------|-------|-------|------|
| **MR 审查** | 启用 MR 自动审查 | `true` | 是否自动审查 MR |
| | 目标分支 | `*` | 审查哪些分支的 MR |
| | 跳过 Draft MR | `false` | 是否跳过草稿 MR |
| | 最小变更行数 | `0` | 最小代码变更行数 |
| **Commit 审查** | 启用 Commit 自动审查 | `true` | 是否自动审查 Commit |
| | 审查分支 | `*` | 审查哪些分支的 Commit |
| | 新分支历史 Commits | `false` | 新分支是否审查历史 |

### **配置说明**

| 配置项 | 启用效果 | 禁用效果 |
|-------|---------|---------|
| **MR 自动审查** | 创建/更新 MR 时自动审查 | 不自动审查 MR |
| **跳过 Draft MR** | 跳过标记为 Draft 的 MR | 审查所有 MR（包括 Draft） |
| **Commit 自动审查** | 每次 push 时自动审查 commit | 不自动审查 commit |
| **新分支历史 Commits** | 新分支首次推送时审查所有历史 | 跳过历史，只审查后续新增 |

### **配置生效范围**

| 级别 | 范围 | 说明 |
|------|-----|------|
| **全局配置** | 所有项目 | 一处配置，全部生效 |
| **项目级配置** | 单个项目 | ❌ 暂不支持 |
| **分支级配置** | 单个分支 | ❌ 暂不支持 |

**配置流程：**

```
修改 Web 界面配置
    ↓
保存到 .env 文件
    ↓
Webhook 触发时读取
    ↓
应用到所有已配置项目
```

---

## 🎨 用户界面

### **主要功能模块**

| 模块 | 功能 | 入口 |
|------|------|------|
| **项目浏览** | 按组浏览 GitLab 项目 | 导航栏 |
| **Webhook 管理** | 批量配置 Webhook | "🔗 批量配置 Webhook" 按钮 |
| **已配置项目** | 查看和管理已配置项目 | "📋 查看已配置项目" 按钮 |
| **审查报表** | 查看审查数据报表 | "📊 AI 代码审查报表" 按钮 |
| **配置管理** | 管理自动审查配置 | "⚙️ 自动审查配置" 按钮 |

### **交互特性**

| 特性 | 说明 | 示例 |
|------|------|------|
| **Loading 状态** | 操作时显示加载动画 | 批量配置时显示"⏳ 配置中..." |
| **按钮禁用** | 防止重复点击 | 操作进行中按钮变灰 |
| **进度反馈** | 实时显示操作进度 | 进度条 + 百分比 |
| **结果提示** | 操作完成后显示结果 | 成功/失败统计弹窗 |
| **二次确认** | 危险操作前确认 | 删除前弹出确认对话框 |
| **快速跳转** | 一键跳转到 GitLab | 点击链接打开 GitLab 页面 |

---

## 🔧 技术特性

### **后端技术栈**

| 技术 | 版本 | 用途 |
|------|-----|------|
| **Flask** | 2.x | Web 框架 |
| **SQLite** | 3.x | 数据库 |
| **Requests** | 2.x | HTTP 请求 |
| **Docker** | - | 运行 PR-Agent |
| **Python** | 3.9+ | 编程语言 |

### **前端技术栈**

| 技术 | 用途 |
|------|------|
| **原生 JavaScript** | 前端逻辑 |
| **Tailwind CSS** | 样式框架 |
| **Fetch API** | AJAX 请求 |
| **响应式设计** | 适配不同屏幕 |

### **AI 集成**

| 项目 | 说明 |
|------|------|
| **AI 模型** | 通义千问 qwen-plus |
| **API 接口** | 阿里云 DashScope API |
| **审查语言** | 中文 |
| **审查内容** | 代码质量、潜在问题、优化建议 |

### **性能优化**

| 优化项 | 方式 | 效果 |
|-------|------|------|
| **并发处理** | 多线程处理 Webhook | 不阻塞主线程 |
| **数据库索引** | project_id, type 索引 | 加快查询速度 |
| **去重机制** | 数据库 + API 检查 | 避免重复审查 |
| **分页加载** | 限制 1000 条记录 | 减少内存占用 |
| **超时控制** | API 30s, 审查 10min | 防止长时间阻塞 |

---

## 📈 审查流程

### **MR 审查流程**

| 步骤 | 操作 | 说明 |
|------|------|------|
| 1 | GitLab 触发 Webhook | MR 创建/更新时触发 |
| 2 | 接收 Webhook 事件 | Flask 接收 POST 请求 |
| 3 | 检查是否需要审查 | 检查配置和去重 |
| 4 | 记录到数据库 | 保存审查记录（如果需要） |
| 5 | 调用 PR-Agent Docker | 执行 `docker run` 命令 |
| 6 | AI 分析代码变更 | 通义千问分析 diff |
| 7 | 生成审查报告 | 生成中文审查报告 |
| 8 | 发布评论到 GitLab | 通过 API 发布评论 |

### **Commit 审查流程**

| 步骤 | 操作 | 说明 |
|------|------|------|
| 1 | GitLab 触发 Webhook | 代码 push 时触发 |
| 2 | 接收 Webhook 事件 | Flask 接收 POST 请求 |
| 3 | 遍历每个 commit | 处理 push 中的所有 commits |
| 4 | 检查是否需要审查 | 跳过 Merge commit 和已审查 |
| 5 | 记录到数据库 | 保存审查记录 |
| 6 | 获取 commit diff | 通过 GitLab API 获取 |
| 7 | 调用 AI API 审查 | 直接调用通义千问 API |
| 8 | 生成审查报告 | 生成中文审查报告 |
| 9 | 发布评论到 GitLab | 通过 API 发布到 commit 页面 |

---

## 🎯 最佳实践

### **Webhook 配置**

| 实践 | 说明 |
|------|------|
| **先测试后推广** | 在测试项目验证功能正常 |
| **确认服务器地址** | 确保 Webhook URL 正确可访问 |
| **定期检查状态** | 使用"查看已配置项目"检查状态 |
| **及时更新配置** | 服务器迁移后及时更新 Webhook |

### **自动审查配置**

| 实践 | 说明 |
|------|------|
| **根据需求调整** | 根据团队需求配置审查范围 |
| **考虑 API 成本** | 合理设置分支过滤，控制调用量 |
| **合理设置分支** | 重要分支开启，测试分支可关闭 |
| **定期查看报表** | 分析审查效果，优化配置 |

### **服务器迁移**

| 步骤 | 操作 |
|------|------|
| 1 | 批量删除旧 Webhook |
| 2 | 启动新服务器 |
| 3 | 批量配置新 Webhook |
| 4 | 验证配置正确 |
| 5 | 测试审查功能 |

---

## 🚀 快速开始

### **启动服务**

```bash
cd /Users/jianqin/pr-agent-dashboard
python3 app.py
```

### **访问地址**

```
http://10.108.2.73:8080
```

### **配置步骤**

| 步骤 | 操作 | 说明 |
|------|------|------|
| 1 | 配置 Webhook | 点击"🔗 批量配置 Webhook" |
| 2 | 选择项目 | 选择需要审查的项目 |
| 3 | 开始配置 | 点击"🚀 开始批量配置" |
| 4 | 配置自动审查 | 点击"⚙️ 自动审查配置" |
| 5 | 调整选项 | 根据需求调整配置 |
| 6 | 保存配置 | 点击"💾 保存配置" |
| 7 | 查看报表 | 点击"📊 AI 代码审查报表" |

---

**版本：** 1.0  
**更新时间：** 2025-11-11  
**维护者：** PR-Agent Dashboard Team
