<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PR-Agent ä»£ç å®¡æŸ¥å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/result-formatter.js"></script>
    <script src="/static/prompts.js"></script>
    <script src="/static/commits.js"></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- å¤´éƒ¨ -->
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold text-gray-900">
                    PR-Agent ä»£ç å®¡æŸ¥å¹³å°
                </h1>
                <p class="mt-2 text-sm text-gray-600">
                    AI é©±åŠ¨çš„ GitLab Merge Request è‡ªåŠ¨åŒ–å®¡æŸ¥å·¥å…·
                </p>
            </div>
        </header>

        <!-- ä¸»å†…å®¹ -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- é¡¹ç›®è¾“å…¥åŒº -->
            <div class="px-4 py-6 sm:px-0">
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-lg font-medium text-gray-900 mb-4">é¡¹ç›®é…ç½®</h2>
                    <div class="space-y-4">
                        <div class="flex gap-4">
                            <input 
                                type="text" 
                                id="projectUrl" 
                                placeholder="è¾“å…¥é¡¹ç›® URLï¼Œä¾‹å¦‚: http://gitlab.it.ikang.com/ios/ikangapp"
                                class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border"
                                value="http://gitlab.it.ikang.com/ios/ikangapp"
                            >
                            <button 
                                onclick="loadMRs()" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-md font-medium"
                            >
                                åŠ è½½ MR åˆ—è¡¨
                            </button>
                        </div>
                        <div class="flex gap-4 items-center">
                            <label class="text-sm font-medium text-gray-700">MR çŠ¶æ€:</label>
                            <select 
                                id="mrState" 
                                class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border"
                                onchange="loadMRs()"
                            >
                                <option value="opened">Open (æœªåˆå¹¶)</option>
                                <option value="merged">Merged (å·²åˆå¹¶)</option>
                                <option value="closed">Closed (å·²å…³é—­)</option>
                                <option value="all">All (å…¨éƒ¨)</option>
                            </select>
                            <span class="text-sm text-gray-500">é€‰æ‹©è¦æŸ¥çœ‹çš„ MR çŠ¶æ€</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MR åˆ—è¡¨åŒº -->
            <div class="px-4 py-6 sm:px-0">
                <div class="bg-white shadow rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-medium text-gray-900">
                            <span id="mrTitle">Merge Requests</span> <span id="mrCount" class="text-gray-500"></span>
                        </h2>
                        <button 
                            onclick="batchReview()" 
                            id="batchReviewBtn"
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium text-sm hidden"
                        >
                            æ‰¹é‡å®¡æŸ¥æœªå®¡æŸ¥çš„ MR
                        </button>
                    </div>
                    
                    <div id="mrList" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">è¯·è¾“å…¥é¡¹ç›® URL å¹¶ç‚¹å‡»"åŠ è½½ MR åˆ—è¡¨"</p>
                    </div>
                </div>
            </div>

            <!-- é…ç½®ä¿¡æ¯ -->
            <div class="px-4 py-6 sm:px-0">
                <div class="bg-white shadow rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-medium text-gray-900">ç³»ç»Ÿé…ç½®</h2>
                        <button 
                            onclick="toggleConfigEdit()" 
                            id="editConfigBtn"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm font-medium"
                        >
                            ç¼–è¾‘é…ç½®
                        </button>
                    </div>
                    
                    <!-- æ˜¾ç¤ºæ¨¡å¼ -->
                    <div id="configDisplay" class="text-sm text-gray-600 space-y-2">
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                    
                    <!-- ç¼–è¾‘æ¨¡å¼ -->
                    <div id="configEdit" class="hidden space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">GitLab URL</label>
                            <input type="text" id="editGitlabUrl" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">GitLab Token</label>
                            <input type="password" id="editGitlabToken" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">AI API Key</label>
                            <input type="password" id="editOpenaiKey" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">AI API Base URL</label>
                            <input type="text" id="editOpenaiApiBase" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">AI Model</label>
                            <input type="text" id="editModel" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å“åº”è¯­è¨€</label>
                            <input type="text" id="editLanguage" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="testConnection()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-medium">
                                æµ‹è¯•è¿æ¥
                            </button>
                            <button onclick="saveConfig()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm font-medium">
                                ä¿å­˜é…ç½®
                            </button>
                            <button onclick="toggleConfigEdit()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded text-sm font-medium">
                                å–æ¶ˆ
                            </button>
                        </div>
                        <div id="configMessage" class="hidden mt-2 p-3 rounded"></div>
                    </div>
                </div>
            </div>

            <!-- Prompt é…ç½® -->
            <div class="px-4 py-6 sm:px-0">
                <div class="bg-white shadow rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-lg font-medium text-gray-900">AI å®¡æŸ¥ Prompt</h2>
                            <p class="text-sm text-gray-500 mt-1">è‡ªå®šä¹‰ AI çš„å®¡æŸ¥é‡ç‚¹å’Œé£æ ¼</p>
                        </div>
                        <button 
                            onclick="togglePromptEdit()" 
                            id="editPromptBtn"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm font-medium"
                        >
                            ç¼–è¾‘ Prompt
                        </button>
                    </div>
                    
                    <!-- æ˜¾ç¤ºæ¨¡å¼ -->
                    <div id="promptDisplay" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å½“å‰ä½¿ç”¨çš„ Prompt æ¨¡æ¿</label>
                            <div id="currentPromptInfo" class="bg-gray-50 rounded p-4">
                                <p class="text-sm text-gray-600">åŠ è½½ä¸­...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç¼–è¾‘æ¨¡å¼ -->
                    <div id="promptEdit" class="hidden space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹© Prompt æ¨¡æ¿</label>
                            <select 
                                id="promptTemplate" 
                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border"
                                onchange="loadPromptTemplate()"
                            >
                                <option value="default">é»˜è®¤å®¡æŸ¥</option>
                                <option value="ios">iOS é¡¹ç›®</option>
                                <option value="backend">åç«¯ API</option>
                                <option value="frontend">å‰ç«¯é¡¹ç›®</option>
                                <option value="security">å®‰å…¨å®¡æŸ¥</option>
                                <option value="performance">æ€§èƒ½ä¼˜åŒ–</option>
                                <option value="custom">è‡ªå®šä¹‰</option>
                            </select>
                            <p id="promptDescription" class="text-sm text-gray-500 mt-1"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prompt å†…å®¹</label>
                            <textarea 
                                id="promptContent" 
                                rows="10"
                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border font-mono text-sm"
                                placeholder="è¾“å…¥è‡ªå®šä¹‰çš„å®¡æŸ¥ Prompt..."
                            ></textarea>
                            <p class="text-xs text-gray-500 mt-1">
                                ğŸ’¡ æç¤ºï¼šPrompt ä¼šå½±å“ AI çš„å®¡æŸ¥é‡ç‚¹å’Œé£æ ¼ï¼Œå¯ä»¥æ ¹æ®é¡¹ç›®ç±»å‹è°ƒæ•´
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="savePrompt()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm font-medium">
                                ä¿å­˜å¹¶åº”ç”¨
                            </button>
                            <button onclick="togglePromptEdit()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded text-sm font-medium">
                                å–æ¶ˆ
                            </button>
                        </div>
                        <div id="promptMessage" class="hidden mt-2 p-3 rounded"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentMRs = [];
        let currentConfig = {};
        let currentPrompts = {};

        // HTML è½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // é¡µé¢åŠ è½½æ—¶è·å–é…ç½®ä¿¡æ¯
        window.onload = function() {
            loadConfig();
            loadPrompts();
        };

        // åŠ è½½é…ç½®ä¿¡æ¯
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                currentConfig = data.full;
                
                document.getElementById('configDisplay').innerHTML = `
                    <p><strong>GitLab URL:</strong> ${data.safe.gitlab_url}</p>
                    <p><strong>GitLab Token:</strong> ${data.safe.gitlab_token_masked}</p>
                    <p><strong>AI API Key:</strong> ${data.safe.openai_key_masked}</p>
                    <p><strong>AI API Base:</strong> ${data.safe.openai_api_base}</p>
                    <p><strong>AI Model:</strong> ${data.safe.model}</p>
                    <p><strong>å“åº”è¯­è¨€:</strong> ${data.safe.language}</p>
                `;
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢é…ç½®ç¼–è¾‘æ¨¡å¼
        function toggleConfigEdit() {
            const display = document.getElementById('configDisplay');
            const edit = document.getElementById('configEdit');
            const btn = document.getElementById('editConfigBtn');
            
            if (edit.classList.contains('hidden')) {
                // è¿›å…¥ç¼–è¾‘æ¨¡å¼
                display.classList.add('hidden');
                edit.classList.remove('hidden');
                btn.textContent = 'å–æ¶ˆç¼–è¾‘';
                
                // å¡«å……å½“å‰é…ç½®
                document.getElementById('editGitlabUrl').value = currentConfig.gitlab_url || '';
                document.getElementById('editGitlabToken').value = currentConfig.gitlab_token || '';
                document.getElementById('editOpenaiKey').value = currentConfig.openai_key || '';
                document.getElementById('editOpenaiApiBase').value = currentConfig.openai_api_base || '';
                document.getElementById('editModel').value = currentConfig.model || '';
                document.getElementById('editLanguage').value = currentConfig.language || '';
            } else {
                // é€€å‡ºç¼–è¾‘æ¨¡å¼
                display.classList.remove('hidden');
                edit.classList.add('hidden');
                btn.textContent = 'ç¼–è¾‘é…ç½®';
                document.getElementById('configMessage').classList.add('hidden');
            }
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            const gitlab_url = document.getElementById('editGitlabUrl').value;
            const gitlab_token = document.getElementById('editGitlabToken').value;
            const messageDiv = document.getElementById('configMessage');
            
            messageDiv.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'text-green-700', 'text-red-700');
            messageDiv.textContent = 'æµ‹è¯•ä¸­...';
            messageDiv.classList.add('bg-blue-100', 'text-blue-700');
            
            try {
                const response = await fetch('/api/config/test', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({gitlab_url, gitlab_token})
                });
                
                const data = await response.json();
                
                messageDiv.classList.remove('bg-blue-100', 'text-blue-700');
                if (data.success) {
                    messageDiv.classList.add('bg-green-100', 'text-green-700');
                    messageDiv.textContent = 'âœ… ' + data.message;
                } else {
                    messageDiv.classList.add('bg-red-100', 'text-red-700');
                    messageDiv.textContent = 'âŒ ' + data.message;
                }
            } catch (error) {
                messageDiv.classList.remove('bg-blue-100', 'text-blue-700');
                messageDiv.classList.add('bg-red-100', 'text-red-700');
                messageDiv.textContent = 'âŒ æµ‹è¯•å¤±è´¥: ' + error.message;
            }
        }

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            const config = {
                gitlab_url: document.getElementById('editGitlabUrl').value,
                gitlab_token: document.getElementById('editGitlabToken').value,
                openai_key: document.getElementById('editOpenaiKey').value,
                openai_api_base: document.getElementById('editOpenaiApiBase').value,
                model: document.getElementById('editModel').value,
                language: document.getElementById('editLanguage').value
            };
            
            const messageDiv = document.getElementById('configMessage');
            messageDiv.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'text-green-700', 'text-red-700');
            messageDiv.textContent = 'ä¿å­˜ä¸­...';
            messageDiv.classList.add('bg-blue-100', 'text-blue-700');
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                messageDiv.classList.remove('bg-blue-100', 'text-blue-700');
                if (data.success) {
                    messageDiv.classList.add('bg-green-100', 'text-green-700');
                    messageDiv.textContent = 'âœ… ' + data.message;
                    
                    // é‡æ–°åŠ è½½é…ç½®
                    setTimeout(() => {
                        loadConfig();
                        toggleConfigEdit();
                    }, 1500);
                } else {
                    messageDiv.classList.add('bg-red-100', 'text-red-700');
                    messageDiv.textContent = 'âŒ ' + (data.error || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                messageDiv.classList.remove('bg-blue-100', 'text-blue-700');
                messageDiv.classList.add('bg-red-100', 'text-red-700');
                messageDiv.textContent = 'âŒ ä¿å­˜å¤±è´¥: ' + error.message;
            }
        }

        // åŠ è½½ MR åˆ—è¡¨
        async function loadMRs() {
            const projectUrl = document.getElementById('projectUrl').value.trim();
            const state = document.getElementById('mrState').value;
            
            if (!projectUrl) {
                alert('è¯·è¾“å…¥é¡¹ç›® URL');
                return;
            }

            const mrList = document.getElementById('mrList');
            mrList.innerHTML = '<p class="text-gray-500 text-center py-8">åŠ è½½ä¸­...</p>';

            try {
                const response = await fetch('/api/projects/mrs', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({project_url: projectUrl, state: state})
                });

                const data = await response.json();
                currentMRs = data.mrs || [];

                // æ›´æ–°æ ‡é¢˜
                const stateNames = {
                    'opened': 'Open',
                    'merged': 'Merged',
                    'closed': 'Closed',
                    'all': 'All'
                };
                document.getElementById('mrTitle').textContent = `${stateNames[state]} Merge Requests`;

                if (currentMRs.length === 0) {
                    mrList.innerHTML = `<p class="text-gray-500 text-center py-8">æ²¡æœ‰æ‰¾åˆ° ${stateNames[state]} çŠ¶æ€çš„ MR</p>`;
                    return;
                }

                document.getElementById('mrCount').textContent = `(${currentMRs.length})`;
                
                // åªåœ¨ Open çŠ¶æ€ä¸‹æ˜¾ç¤ºæ‰¹é‡å®¡æŸ¥æŒ‰é’®
                const batchBtn = document.getElementById('batchReviewBtn');
                if (state === 'opened') {
                    const unreviewed = currentMRs.filter(mr => !mr.reviewed);
                    if (unreviewed.length > 0) {
                        batchBtn.classList.remove('hidden');
                    } else {
                        batchBtn.classList.add('hidden');
                    }
                } else {
                    batchBtn.classList.add('hidden');
                }

                renderMRList();
            } catch (error) {
                console.error('åŠ è½½ MR å¤±è´¥:', error);
                mrList.innerHTML = '<p class="text-red-500 text-center py-8">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é¡¹ç›® URL å’Œç½‘ç»œè¿æ¥</p>';
            }
        }

        // æ¸²æŸ“ MR åˆ—è¡¨
        function renderMRList() {
            const mrList = document.getElementById('mrList');
            mrList.innerHTML = currentMRs.map(mr => {
                // çŠ¶æ€æ ‡ç­¾
                let statusBadge = '';
                if (mr.state === 'merged') {
                    statusBadge = '<span class="px-2 py-1 text-xs font-medium text-purple-700 bg-purple-100 rounded">å·²åˆå¹¶</span>';
                } else if (mr.state === 'closed') {
                    statusBadge = '<span class="px-2 py-1 text-xs font-medium text-red-700 bg-red-100 rounded">å·²å…³é—­</span>';
                } else if (mr.state === 'opened') {
                    statusBadge = '<span class="px-2 py-1 text-xs font-medium text-blue-700 bg-blue-100 rounded">Open</span>';
                }
                
                // å®¡æŸ¥çŠ¶æ€æ ‡ç­¾
                let reviewBadge = '';
                if (mr.state === 'opened') {
                    reviewBadge = mr.reviewed ? 
                        '<span class="px-2 py-1 text-xs font-medium text-green-700 bg-green-100 rounded">å·²å®¡æŸ¥</span>' :
                        '<span class="px-2 py-1 text-xs font-medium text-yellow-700 bg-yellow-100 rounded">æœªå®¡æŸ¥</span>';
                }
                
                return `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-sm font-medium text-gray-500">!${mr.iid}</span>
                                <h3 class="text-base font-medium text-gray-900">${mr.title}</h3>
                                ${statusBadge}
                                ${reviewBadge}
                            </div>
                            <p class="mt-1 text-sm text-gray-500">
                                ä½œè€…: ${mr.author.name} | 
                                åˆ›å»ºæ—¶é—´: ${new Date(mr.created_at).toLocaleString('zh-CN')}
                            </p>
                            <p class="mt-1 text-sm text-gray-600">
                                ${mr.source_branch} â†’ ${mr.target_branch}
                            </p>
                        </div>
                        <div class="flex gap-2 ml-4">
                            ${mr.state === 'opened' ? `
                                <button 
                                    onclick="reviewMR('${mr.web_url}', ${mr.iid})"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium"
                                    id="reviewBtn-${mr.iid}"
                                >
                                    ${mr.reviewed ? 'é‡æ–°å®¡æŸ¥' : 'ç«‹å³å®¡æŸ¥'}
                                </button>
                            ` : ''}
                            ${mr.state === 'merged' || mr.state === 'closed' ? `
                                <button 
                                    onclick="reviewMR('${mr.web_url}', ${mr.iid})"
                                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-sm font-medium"
                                    id="reviewBtn-${mr.iid}"
                                    title="å¯¹å·²${mr.state === 'merged' ? 'åˆå¹¶' : 'å…³é—­'}çš„ MR è¿›è¡Œ AI åˆ†æ"
                                >
                                    AI åˆ†æ
                                </button>
                            ` : ''}
                            <button 
                                onclick="toggleCommits(${mr.iid}, '${mr.web_url}')"
                                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm font-medium"
                                id="commitsBtn-${mr.iid}"
                            >
                                æŸ¥çœ‹ Commits
                            </button>
                            <a 
                                href="${mr.web_url}" 
                                target="_blank"
                                class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded text-sm font-medium"
                            >
                                æŸ¥çœ‹ MR
                            </a>
                        </div>
                    </div>
                    <div id="progress-${mr.iid}" class="mt-4 hidden">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full progress-bar" style="width: 0%" id="progressBar-${mr.iid}"></div>
                        </div>
                        <p class="mt-2 text-sm text-gray-600" id="progressText-${mr.iid}">å‡†å¤‡ä¸­...</p>
                    </div>
                    
                    <!-- Commits åˆ—è¡¨æ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="commits-${mr.iid}" class="mt-4 hidden">
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-medium text-gray-900">Commits åˆ—è¡¨</h4>
                                <button 
                                    onclick="toggleCommits(${mr.iid}, '${mr.web_url}')"
                                    class="text-sm text-indigo-600 hover:text-indigo-800"
                                >
                                    æ”¶èµ·
                                </button>
                            </div>
                            <div id="commitsContent-${mr.iid}" class="space-y-2">
                                <p class="text-gray-600 text-sm">åŠ è½½ä¸­...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å®¡æŸ¥ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="result-${mr.iid}" class="mt-4 hidden">
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-medium text-gray-900">AI å®¡æŸ¥ç»“æœ</h4>
                                <button 
                                    onclick="toggleResult(${mr.iid})"
                                    class="text-sm text-indigo-600 hover:text-indigo-800"
                                    id="toggleResultBtn-${mr.iid}"
                                >
                                    æ”¶èµ·
                                </button>
                            </div>
                            <div id="resultContent-${mr.iid}" class="bg-gray-50 rounded p-4 text-sm overflow-auto max-h-96">
                                <p class="text-gray-600">åŠ è½½ä¸­...</p>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // åˆ‡æ¢ç»“æœæ˜¾ç¤º
        function toggleResult(mrId) {
            const content = document.getElementById('resultContent-' + mrId);
            const btn = document.getElementById('toggleResultBtn-' + mrId);
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                btn.textContent = 'æ”¶èµ·';
            } else {
                content.classList.add('hidden');
                btn.textContent = 'å±•å¼€';
            }
        }

        // å®¡æŸ¥å•ä¸ª MR
        async function reviewMR(mrUrl, mrId) {
            const btn = document.getElementById(`reviewBtn-${mrId}`);
            const progress = document.getElementById(`progress-${mrId}`);
            const progressBar = document.getElementById(`progressBar-${mrId}`);
            const progressText = document.getElementById(`progressText-${mrId}`);

            // åˆ¤æ–­æ˜¯å®¡æŸ¥è¿˜æ˜¯åˆ†æ
            const isAnalysis = btn.textContent.includes('AI åˆ†æ');
            const actionText = isAnalysis ? 'åˆ†æ' : 'å®¡æŸ¥';

            btn.disabled = true;
            btn.textContent = `${actionText}ä¸­...`;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            progress.classList.remove('hidden');

            try {
                // å¯åŠ¨å®¡æŸ¥
                const response = await fetch('/api/review', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({mr_url: mrUrl, mr_id: mrId.toString()})
                });

                const data = await response.json();

                // è½®è¯¢çŠ¶æ€
                const checkStatus = setInterval(async () => {
                    const statusResponse = await fetch(`/api/review/status/${mrId}`);
                    const status = await statusResponse.json();

                    progressBar.style.width = `${status.progress || 0}%`;
                    progressText.textContent = status.message || 'å¤„ç†ä¸­...';

                    if (status.status === 'success') {
                        clearInterval(checkStatus);
                        btn.textContent = `${actionText}å®Œæˆ âœ“`;
                        btn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-purple-600', 'hover:bg-purple-700');
                        btn.classList.add('bg-green-600');
                        progressText.textContent = `âœ… ${actionText}å®Œæˆï¼ç»“æœå·²æ˜¾ç¤ºåœ¨ä¸‹æ–¹`;
                        progressText.classList.add('text-green-600', 'font-medium');
                        
                        // æ˜¾ç¤ºç»“æœï¼ˆä½¿ç”¨æ ¼å¼åŒ–ï¼‰
                        if (status.output) {
                            const resultDiv = document.getElementById('result-' + mrId);
                            const resultContent = document.getElementById('resultContent-' + mrId);
                            resultDiv.classList.remove('hidden');
                            resultContent.innerHTML = formatReviewResult(status.output);
                        }
                        
                        // 3ç§’ååˆ·æ–°åˆ—è¡¨
                        setTimeout(() => loadMRs(), 3000);
                    } else if (status.status === 'failed') {
                        clearInterval(checkStatus);
                        btn.textContent = `${actionText}å¤±è´¥`;
                        btn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-purple-600', 'hover:bg-purple-700');
                        btn.classList.add('bg-red-600');
                        progressText.textContent = 'âŒ ' + (status.message || `${actionText}å¤±è´¥`);
                        progressText.classList.add('text-red-600');
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }, 2000);

            } catch (error) {
                console.error(`${actionText}å¤±è´¥:`, error);
                btn.textContent = `${actionText}å¤±è´¥`;
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                progressText.textContent = `âŒ ${actionText}å¤±è´¥: ` + error.message;
                progressText.classList.add('text-red-600');
            }
        }

        // æ‰¹é‡å®¡æŸ¥
        async function batchReview() {
            const unreviewed = currentMRs.filter(mr => !mr.reviewed);
            if (unreviewed.length === 0) {
                alert('æ²¡æœ‰æœªå®¡æŸ¥çš„ MR');
                return;
            }

            if (!confirm(`ç¡®å®šè¦å®¡æŸ¥ ${unreviewed.length} ä¸ª MR å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚`)) {
                return;
            }

            // ä¾æ¬¡å®¡æŸ¥æ¯ä¸ª MR
            for (const mr of unreviewed) {
                await reviewMR(mr.web_url, mr.iid);
                // ç­‰å¾…5ç§’å†å®¡æŸ¥ä¸‹ä¸€ä¸ªï¼Œé¿å…APIé™æµ
                await new Promise(resolve => setTimeout(resolve, 5000));
            }
        }
    </script>
</body>
</html>
