# 📂 文件级审核功能说明

## 🎯 功能概述

文件级审核是一种**详细的代码审查模式**，相比总体审核，它能够：
- 按文件分组进行独立评分
- 按代码区块（新增/修改/删除）进行分段分析
- 提供更精确的问题定位和具体的修复建议
- 识别安全漏洞、性能问题、代码规范等

---

## ⚙️ 配置方式

### 1. 手动审查页面（即时选择）✅ **推荐**

**适用场景：** 手动触发审查时临时启用

1. 访问 **✋ 手动审查** 页面
2. 在项目配置区域下方找到 **📂 启用文件级审核（详细模式）**
3. 勾选复选框
4. 点击 **审查** 按钮

**特点：**
- ✅ 每次审查时可以灵活选择
- ✅ 不影响自动审查配置
- ✅ 适合重要 MR/Commit 的详细审查

---

### 2. Webhook 配置页面（全局配置）

**适用场景：** 自动审查时默认启用

1. 访问 **Webhook 配置** 页面
2. 进入 **步骤 4: 自动审查配置**
3. 展开 **📝 Commit 自动审查** 选项
4. 找到 **📂 启用文件级审核（详细模式）** 开关
5. 勾选开关启用
6. 点击 **💾 保存自动审查配置**

**特点：**
- ✅ 全局配置，所有自动审查都生效
- ✅ 适合对代码质量要求高的项目
- ⚠️ 会增加审查时间和成本

---

### 3. 配置文件方式（高级）

在 `~/.pr-agent-test/.env` 文件中添加：

```bash
# 文件级审核配置（默认关闭）
AUTO_REVIEW_FILE_LEVEL_ENABLED=true
```

**注意：** 此配置仅影响 Webhook 自动审查，不影响手动审查

---

## 📊 审核模式对比

| 特性 | 总体审核（默认） | 文件级审核 |
|------|----------------|-----------|
| **审核粒度** | Commit 整体 | 文件 + 代码区块 |
| **问题定位** | 模糊 | 精确到文件和区块 |
| **审核时间** | 5-10秒 | 20-40秒 |
| **AI 调用** | 1次 | 多次（按文件数） |
| **成本** | 低 | 中等 |
| **建议详细度** | ⭐⭐ | ⭐⭐⭐⭐ |
| **适用场景** | 日常开发 | 重要功能、安全相关 |

---

## 📝 审核报告示例

### 总体审核报告（默认）
```
Commit: a1b2c3d - "优化用户登录逻辑"
总体评分: C+

主要问题：
- 存在 SQL 注入风险
- 密码处理不安全
- 缺少日志记录

建议：
- 使用参数化查询
- 使用密码加密
- 添加审计日志
```

### 文件级审核报告（详细）
```
┌─────────────────────────────────────────────┐
│ 📊 Commit 审核报告                           │
│ Commit: a1b2c3d - "优化用户登录逻辑"         │
│ 总体评分: ⚠️ C+ (需要改进)                   │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 📁 文件 1/3: auth.py                         │
│ 变更: +28 行, -5 行                          │
│ 风险等级: 🔴 高风险                          │
│ 文件评分: D (存在严重问题)                   │
├─────────────────────────────────────────────┤
│                                              │
│ 🔍 区块 1: 新增登录函数 (Line 18-26)        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 代码片段:                                    │
│   def login(self, username, password):      │
│       user = self.db.query(                 │
│           f"SELECT * FROM users..."         │
│       )                                      │
│                                              │
│ ❌ 严重问题 (3个):                           │
│   1. SQL 注入风险                            │
│      • 使用了字符串拼接构建 SQL 查询         │
│      • 风险: 攻击者可以注入恶意 SQL 代码     │
│      💡 建议: 使用参数化查询                 │
│         user = self.db.query(               │
│             "SELECT * FROM users WHERE ...", │
│             (username,)                     │
│         )                                    │
│                                              │
│   2. 密码明文比对                            │
│      • 直接比对密码字符串                    │
│      💡 建议: 使用 bcrypt 加密               │
│         import bcrypt                       │
│         if bcrypt.checkpw(password, ...):   │
│                                              │
│   3. 缺少登录失败限制                        │
│      💡 建议: 添加失败次数限制和验证码       │
│                                              │
│ ⚠️ 警告 (1个):                               │
│   1. 缺少日志记录                            │
│      💡 建议: 记录登录成功/失败事件          │
│                                              │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 📁 文件 2/3: api/routes.py                   │
│ 变更: +18 行, -0 行                          │
│ 风险等级: 🟡 中风险                          │
│ 文件评分: B- (基本合格)                      │
├─────────────────────────────────────────────┤
│                                              │
│ 🔍 区块 1: 新增 Token 刷新接口 (Line 123-136)│
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ ⚠️ 警告 (2个):                               │
│   1. 缺少 Token 前缀处理                     │
│      💡 建议: 处理 "Bearer <token>" 格式     │
│   2. 缺少刷新频率限制                        │
│      💡 建议: 添加刷新次数限制               │
│                                              │
│ ✅ 优点:                                     │
│   • API 设计符合 RESTful 规范                │
│   • 错误处理较完善                           │
│                                              │
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│ 📊 总体评估                                  │
├─────────────────────────────────────────────┤
│ 🎯 评分明细:                                 │
│   • 安全性: ❌ 2/10 (存在严重安全问题)       │
│   • 代码质量: ⚠️ 5/10 (需要改进)             │
│   • 功能完整性: ⚠️ 6/10 (部分功能未实现)     │
│                                              │
│ 🔴 严重问题 (必须修复):                      │
│   1. SQL 注入漏洞 - auth.py Line 23         │
│   2. 密码明文存储/比对 - auth.py Line 24    │
│   3. 登出功能未实现 - api/routes.py Line 138│
│                                              │
│ 📝 审核结论:                                 │
│   ⛔ 不建议合并                              │
│   原因: 存在严重安全漏洞                     │
│                                              │
└─────────────────────────────────────────────┘
```

---

## 💰 成本分析

### 假设场景
- 每个 Commit 平均 3 个文件变更
- 每天 50 个 Commits

### 总体审核（默认）
```
50 commits × 2000 tokens = 100,000 tokens/天
成本：约 ¥1-2/天
```

### 文件级审核
```
50 commits × 3 files × 1500 tokens = 225,000 tokens/天
成本：约 ¥2-5/天
```

**建议：**
- 日常开发使用总体审核
- 重要功能、安全相关代码启用文件级审核
- 可以根据项目重要性灵活切换

---

## 🚀 使用建议

### 适合启用文件级审核的场景

✅ **推荐启用：**
- 认证授权相关代码
- 支付交易相关代码
- 数据库操作相关代码
- API 接口变更
- 核心业务逻辑
- 安全相关功能

❌ **不推荐启用：**
- 文档更新
- 注释修改
- 格式调整
- 简单的配置修改
- 测试代码（非核心）

### 最佳实践

1. **默认关闭**：日常开发使用总体审核
2. **按需启用**：重要功能开发时临时启用
3. **定期审查**：每周对核心代码进行文件级审核
4. **成本控制**：监控 AI 调用次数和成本

---

## 🔧 技术实现

### 配置存储
- 配置文件：`~/.pr-agent-test/.env`
- 配置项：`AUTO_REVIEW_FILE_LEVEL_ENABLED`
- 默认值：`false`（关闭）

### API 接口
- 获取配置：`GET /api/auto-review/config`
- 保存配置：`POST /api/auto-review/config`

### 前端组件
- 配置页面：`templates/index.html` - 步骤 4
- 配置逻辑：`static/auto-review-config.js`

### 后端处理
- 配置读取：`app.py` - `get_auto_review_config()`
- 配置保存：`app.py` - `update_auto_review_config()`
- Webhook 处理：根据配置选择审核模式

---

## 📖 相关文档

- [Webhook 配置指南](./WEBHOOK_SETUP.md)
- [自动审查配置](./AUTO_REVIEW.md)
- [PR-Agent 使用手册](./README.md)

---

## ❓ 常见问题

### Q1: 文件级审核会影响审查速度吗？
A: 是的，文件级审核需要对每个文件单独调用 AI，审查时间会增加 2-4 倍。

### Q2: 可以只对特定文件启用文件级审核吗？
A: 当前版本是全局配置，后续版本会支持按文件类型或文件路径配置。

### Q3: 文件级审核的成本如何？
A: 成本约为总体审核的 2-3 倍，但提供的信息更详细和精确。

### Q4: 如何查看审核报告？
A: 审核报告会以 GitLab Comment 的形式回复到对应的 Commit 或 MR。

### Q5: 可以临时关闭文件级审核吗？
A: 可以，在 Webhook 配置页面取消勾选即可，无需重启服务。

---

**最后更新：2025-11-13**
